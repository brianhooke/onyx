<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onyx - Robot Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-connected { background-color: #22c55e; }
        .status-disconnected { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        
        /* Gauge animation */
        [id^="gauge-"] {
            transition: stroke-dashoffset 0.2s ease-out, opacity 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-gray-500 text-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Onyx</h1>
                <p class="text-gray-500">ABB IRB 6700 Robot Control System</p>
            </div>
            <a href="/toolpath/" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Toolpath Generator
            </a>
        </div>

        <!-- Connection Status Card -->
        <div class="bg-white rounded-xl p-6 mb-6 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Controller Status</h2>
                <button onclick="refreshStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                    Refresh
                </button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">Connection</div>
                    <div class="flex items-center gap-2">
                        <span id="connection-indicator" class="status-indicator status-disconnected"></span>
                        <span id="connection-status" class="font-medium">Checking...</span>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">Controller State</div>
                    <div id="controller-state" class="font-medium">-</div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">Operation Mode</div>
                    <div id="operation-mode" class="font-medium">-</div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">Execution State</div>
                    <div id="execution-state" class="font-medium">-</div>
                </div>
            </div>
            
            <div class="mt-4 text-sm text-gray-500">
                <span>RobotWare: </span>
                <span id="robotware-version">-</span>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-xl p-6 mb-6 shadow-sm border border-gray-200">
            <h2 class="text-xl font-semibold mb-4">Program Control</h2>
            
            <div class="flex flex-wrap gap-4">
                <button onclick="startExecution()" id="btn-start"
                    class="bg-green-600 hover:bg-green-700 text-white disabled:bg-gray-300 disabled:cursor-not-allowed px-6 py-3 rounded-lg font-medium">
                    ▶ Start
                </button>
                
                <button onclick="stopExecution()" id="btn-stop"
                    class="bg-red-600 hover:bg-red-700 text-white disabled:bg-gray-300 disabled:cursor-not-allowed px-6 py-3 rounded-lg font-medium">
                    ■ Stop
                </button>
                
                <button onclick="resetPP()" id="btn-reset"
                    class="bg-amber-500 hover:bg-amber-600 text-white disabled:bg-gray-300 disabled:cursor-not-allowed px-6 py-3 rounded-lg font-medium">
                    ↺ Reset PP
                </button>
            </div>
            
            <div id="control-message" class="mt-4 text-sm hidden"></div>
        </div>

        <!-- Robot Position -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- TCP Position -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">TCP Position (World)</h2>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                        <div class="text-gray-500 text-xs mb-1">X</div>
                        <div id="tcp-x" class="font-mono text-lg">-</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                        <div class="text-gray-500 text-xs mb-1">Y</div>
                        <div id="tcp-y" class="font-mono text-lg">-</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                        <div class="text-gray-500 text-xs mb-1">Z</div>
                        <div id="tcp-z" class="font-mono text-lg">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Joint Positions -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Joint Angles (°)</h2>
                <div class="grid grid-cols-4 gap-2 text-center">
                    <div class="bg-gray-50 rounded-lg p-2 border border-gray-100">
                        <div class="text-gray-500 text-xs">J1</div>
                        <div id="joint-1" class="font-mono text-sm">-</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2 border border-gray-100">
                        <div class="text-gray-500 text-xs">J2</div>
                        <div id="joint-2" class="font-mono text-sm">-</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2 border border-gray-100">
                        <div class="text-gray-500 text-xs">J3</div>
                        <div id="joint-3" class="font-mono text-sm">-</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2 border border-gray-100">
                        <div class="text-gray-500 text-xs">J4</div>
                        <div id="joint-4" class="font-mono text-sm">-</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2 border border-gray-100">
                        <div class="text-gray-500 text-xs">J5</div>
                        <div id="joint-5" class="font-mono text-sm">-</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2 border border-gray-100">
                        <div class="text-gray-500 text-xs">J6</div>
                        <div id="joint-6" class="font-mono text-sm">-</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2 border border-gray-100 col-span-2">
                        <div class="text-gray-500 text-xs">Track</div>
                        <div id="joint-track" class="font-mono text-sm">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Force/Torque Sensor Panel -->
        <div class="bg-white rounded-xl p-6 mb-6 shadow-sm border border-gray-200">
            <h2 class="text-xl font-semibold mb-4">Force / Torque Sensor</h2>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
                <!-- Fx -->
                <div class="flex flex-col items-center">
                    <div class="relative w-20 h-20">
                        <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle id="gauge-fx" cx="50" cy="50" r="40" stroke="#3b82f6" stroke-width="8" fill="none"
                                stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="value-fx" class="text-sm font-bold text-blue-400">0</span>
                            <span class="text-xs text-gray-500">N</span>
                        </div>
                    </div>
                    <span class="text-sm text-gray-400 mt-1">Fx</span>
                </div>
                <!-- Fy -->
                <div class="flex flex-col items-center">
                    <div class="relative w-20 h-20">
                        <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle id="gauge-fy" cx="50" cy="50" r="40" stroke="#22c55e" stroke-width="8" fill="none"
                                stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="value-fy" class="text-sm font-bold text-green-400">0</span>
                            <span class="text-xs text-gray-500">N</span>
                        </div>
                    </div>
                    <span class="text-sm text-gray-400 mt-1">Fy</span>
                </div>
                <!-- Fz -->
                <div class="flex flex-col items-center">
                    <div class="relative w-20 h-20">
                        <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle id="gauge-fz" cx="50" cy="50" r="40" stroke="#f59e0b" stroke-width="8" fill="none"
                                stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="value-fz" class="text-sm font-bold text-amber-400">0</span>
                            <span class="text-xs text-gray-500">N</span>
                        </div>
                    </div>
                    <span class="text-sm text-gray-400 mt-1">Fz</span>
                </div>
                <!-- Tx -->
                <div class="flex flex-col items-center">
                    <div class="relative w-20 h-20">
                        <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle id="gauge-tx" cx="50" cy="50" r="40" stroke="#8b5cf6" stroke-width="8" fill="none"
                                stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="value-tx" class="text-sm font-bold text-violet-400">0</span>
                            <span class="text-xs text-gray-500">Nm</span>
                        </div>
                    </div>
                    <span class="text-sm text-gray-400 mt-1">Tx</span>
                </div>
                <!-- Ty -->
                <div class="flex flex-col items-center">
                    <div class="relative w-20 h-20">
                        <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle id="gauge-ty" cx="50" cy="50" r="40" stroke="#ec4899" stroke-width="8" fill="none"
                                stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="value-ty" class="text-sm font-bold text-pink-400">0</span>
                            <span class="text-xs text-gray-500">Nm</span>
                        </div>
                    </div>
                    <span class="text-sm text-gray-400 mt-1">Ty</span>
                </div>
                <!-- Tz -->
                <div class="flex flex-col items-center">
                    <div class="relative w-20 h-20">
                        <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle id="gauge-tz" cx="50" cy="50" r="40" stroke="#06b6d4" stroke-width="8" fill="none"
                                stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="value-tz" class="text-sm font-bold text-cyan-400">0</span>
                            <span class="text-xs text-gray-500">Nm</span>
                        </div>
                    </div>
                    <span class="text-sm text-gray-400 mt-1">Tz</span>
                </div>
            </div>
            <div class="mt-4 text-xs text-gray-500 text-center">
                <span id="ft-status-indicator" class="inline-block w-2 h-2 rounded-full bg-gray-500 mr-1"></span>
                <span id="ft-status-text">Waiting for ForceMonitor... (run ForceMonitorStart on pendant)</span>
            </div>
        </div>

        <!-- Program Info & Speed -->
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Program Pointer</h2>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Module:</span>
                        <span id="pp-module" class="font-mono">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Routine:</span>
                        <span id="pp-routine" class="font-mono">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Line:</span>
                        <span id="pp-line" class="font-mono">-</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Current Speed</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-gray-500 text-xs mb-1">TCP</div>
                        <div id="tcp-speed" class="text-2xl font-bold text-blue-400">-</div>
                        <div class="text-gray-500 text-xs">m/s</div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs mb-1">Track</div>
                        <div id="track-speed" class="text-2xl font-bold text-green-400">-</div>
                        <div class="text-gray-500 text-xs">m/s</div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Recent Events</h2>
                <div id="event-log" class="space-y-2 text-sm max-h-32 overflow-y-auto">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Tasks & Modules -->
        <div class="bg-white rounded-xl p-6 mb-6 shadow-sm border border-gray-200">
            <h2 class="text-xl font-semibold mb-4">RAPID Tasks</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-gray-500 text-sm mb-2">Task</label>
                    <select id="task-select" onchange="loadModules()" 
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-gray-900">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-500 text-sm mb-2">Module</label>
                    <select id="module-select" 
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-gray-900">
                        <option value="">Select a task first</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tool Changer Status -->
        <div class="bg-white rounded-xl p-6 mb-6 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Tool Changer</h2>
                <div class="flex items-center gap-2">
                    <span id="tc-update-indicator" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-xs text-gray-400">Live</span>
                </div>
            </div>
            
            <div class="grid md:grid-cols-4 gap-4">
                <!-- Current Tool -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">Current Tool</div>
                    <div class="flex items-center gap-2">
                        <span id="tc-tool-num" class="text-2xl font-bold text-blue-400">-</span>
                        <span id="tc-tool-name" class="text-gray-700">Loading...</span>
                    </div>
                </div>
                
                <!-- Tool State -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">Changer State</div>
                    <div id="tc-state" class="text-xl font-semibold text-gray-700">-</div>
                </div>
                
                <!-- Program Pointer -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">Program Pointer</div>
                    <div id="tc-prog-ptr" class="text-sm font-mono text-yellow-400 truncate">-</div>
                    <div id="tc-prog-line" class="text-xs text-gray-500 mt-1">-</div>
                </div>
                
                <!-- Signals -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="text-gray-400 text-sm mb-2">I/O Signals</div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <div class="flex items-center gap-2">
                            <span id="tc-do13" class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                            <span class="text-gray-600">DO13 Release</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="tc-di13" class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                            <span class="text-gray-600">DI13 Released</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="tc-do14" class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                            <span class="text-gray-400">DO14 Grip</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="tc-di14" class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                            <span class="text-gray-400">DI14 Gripped</span>
                        </div>
                        <div class="flex items-center gap-2 col-span-2 mt-1 pt-1 border-t border-gray-600">
                            <span id="tc-di2" class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                            <span class="text-gray-400">DI2 Heli Home</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log & Alerts -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Activity Log -->
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Activity Log</h2>
                    <div class="flex items-center gap-2">
                        <span id="activity-update-indicator" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-xs text-gray-400">Live</span>
                    </div>
                </div>
                <div id="activity-log" class="space-y-1 max-h-80 overflow-y-auto text-sm font-mono">
                    <div class="text-gray-500">Loading activity...</div>
                </div>
            </div>
            
            <!-- Alerts / Errors -->
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <h2 class="text-xl font-semibold">Alerts</h2>
                        <span id="alert-count" class="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-600 text-gray-300">0</span>
                    </div>
                    <button onclick="clearAlertHighlights()" class="text-xs text-gray-400 hover:text-white">Clear highlights</button>
                </div>
                <div id="alerts-log" class="space-y-2 max-h-80 overflow-y-auto text-sm">
                    <div class="text-gray-500">No alerts</div>
                </div>
            </div>
        </div>

        <!-- System Diagnostics -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-semibold">System Diagnostics</h2>
                    <span id="health-badge" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-600">
                        Loading...
                    </span>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-400">
                    <span id="diag-update-indicator" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span>Live updates every 2s</span>
                </div>
            </div>

            <!-- Health Summary Banner -->
            <div id="health-banner" class="hidden mb-4 p-3 rounded-lg">
                <div class="flex items-center gap-2">
                    <span id="health-icon"></span>
                    <span id="health-message" class="text-sm font-medium"></span>
                </div>
            </div>

            <!-- Diagnostic Tables Grid -->
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="diagnostics-grid">
                <!-- Tables will be populated by JavaScript -->
                <div class="text-gray-500 text-center py-8 col-span-full">Loading diagnostics...</div>
            </div>

            <!-- Signal Legend -->
            <div class="mt-4 pt-4 border-t border-gray-700 flex flex-wrap gap-4 text-xs text-gray-400">
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                    <span>OK</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                    <span>Fault</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                    <span>Active</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 rounded-full bg-gray-500"></span>
                    <span>Off/Unknown</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-blue-400">DI</span>
                    <span>= Input</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-purple-400">DO</span>
                    <span>= Output</span>
                </div>
                <div class="ml-auto flex items-center gap-3">
                    <a href="/api/events/latest/" target="_blank" class="text-blue-400 hover:text-blue-300 underline">Latest Event</a>
                    <a href="/api/events/detailed/" target="_blank" class="text-blue-400 hover:text-blue-300 underline">Event Log</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Refresh status on page load
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
            refreshPosition();
            refreshEvents();
            loadTasks();
            refreshDiagnostics();
            refreshToolChanger();
            refreshActivityLog();
        });

        // Auto-refresh every 5 seconds (IRC5 has 70 connection limit)
        setInterval(refreshStatus, 5000);
        setInterval(refreshPosition, 3000);
        setInterval(refreshEvents, 10000);
        setInterval(refreshDiagnostics, 2000);
        setInterval(refreshToolChanger, 1000);  // Tool changer updates every 1s for debugging
        setInterval(refreshActivityLog, 2000);  // Activity log updates every 2s

        function formatNum(val, decimals = 1) {
            if (val === null || val === undefined) return '-';
            const num = parseFloat(val);
            return isNaN(num) ? '-' : num.toFixed(decimals);
        }

        // Velocity calculation state
        let lastPosition = null;
        let lastPositionTime = null;

        // Force/Torque UI
        const FORCE_MAX = 500;  // Max force in Newtons for gauge scale
        const TORQUE_MAX = 50;  // Max torque in Nm for gauge scale
        const CIRCUMFERENCE = 251.2;  // 2 * PI * 40 (radius)

        function updateGauge(id, value, maxValue) {
            const gauge = document.getElementById('gauge-' + id);
            const valueEl = document.getElementById('value-' + id);
            if (!gauge || !valueEl) return;
            
            const absValue = Math.abs(value);
            const percent = Math.min(absValue / maxValue, 1);
            const offset = CIRCUMFERENCE * (1 - percent);
            gauge.style.strokeDashoffset = offset;
            valueEl.textContent = absValue.toFixed(1);
        }

        function updateForceTorqueDisplay(fx, fy, fz, tx, ty, tz) {
            updateGauge('fx', fx, FORCE_MAX);
            updateGauge('fy', fy, FORCE_MAX);
            updateGauge('fz', fz, FORCE_MAX);
            updateGauge('tx', tx, TORQUE_MAX);
            updateGauge('ty', ty, TORQUE_MAX);
            updateGauge('tz', tz, TORQUE_MAX);
        }

        async function refreshForceTorque() {
            try {
                const response = await fetch('/api/force-torque/');
                const data = await response.json();
                
                const indicator = document.getElementById('ft-status-indicator');
                const statusText = document.getElementById('ft-status-text');
                
                if (data.status === 'ok') {
                    indicator.className = 'inline-block w-2 h-2 rounded-full bg-green-500 mr-1 animate-pulse';
                    statusText.textContent = 'Live @ 2Hz';
                    updateForceTorqueDisplay(data.fx, data.fy, data.fz, data.tx, data.ty, data.tz);
                } else if (data.status === 'not_running') {
                    indicator.className = 'inline-block w-2 h-2 rounded-full bg-yellow-500 mr-1';
                    statusText.textContent = 'ForceMonitor not running (run ForceMonitorStart on pendant)';
                    updateForceTorqueDisplay(0, 0, 0, 0, 0, 0);
                } else {
                    indicator.className = 'inline-block w-2 h-2 rounded-full bg-gray-500 mr-1';
                    statusText.textContent = 'No data - ForceMonitor.mod not loaded';
                    updateForceTorqueDisplay(0, 0, 0, 0, 0, 0);
                }
            } catch (error) {
                console.error('Force/torque refresh failed:', error);
            }
        }
        
        // Poll force/torque at 2Hz (matching RAPID update rate)
        setInterval(refreshForceTorque, 500);

        async function refreshStatus() {
            try {
                const response = await fetch('/api/status/?extended=true');
                const data = await response.json();
                
                const indicator = document.getElementById('connection-indicator');
                const status = document.getElementById('connection-status');
                
                if (data.connected) {
                    indicator.className = 'status-indicator status-connected';
                    status.textContent = 'Connected';
                    
                    document.getElementById('controller-state').textContent = data.controller_state || '-';
                    document.getElementById('operation-mode').textContent = data.operation_mode || '-';
                    document.getElementById('execution-state').textContent = data.execution_state || '-';
                    document.getElementById('robotware-version').textContent = data.robotware_version || '-';
                    
                    // Program pointer
                    if (data.program_pointer) {
                        document.getElementById('pp-module').textContent = data.program_pointer.module || '-';
                        document.getElementById('pp-routine').textContent = data.program_pointer.routine || '-';
                        document.getElementById('pp-line').textContent = data.program_pointer.line || '-';
                    }
                    
                    // Enable buttons - works in both AUTO and MANUAL (with deadman held)
                    document.getElementById('btn-start').disabled = false;
                    document.getElementById('btn-stop').disabled = false;
                    document.getElementById('btn-reset').disabled = false;
                } else {
                    indicator.className = 'status-indicator status-disconnected';
                    status.textContent = 'Disconnected';
                    document.getElementById('controller-state').textContent = '-';
                    document.getElementById('operation-mode').textContent = '-';
                    document.getElementById('execution-state').textContent = '-';
                }
            } catch (error) {
                console.error('Status refresh failed:', error);
            }
        }

        async function refreshPosition() {
            try {
                const response = await fetch('/api/position/');
                const data = await response.json();
                const now = Date.now();
                
                if (data.tcp) {
                    const x = parseFloat(data.tcp.x);
                    const y = parseFloat(data.tcp.y);
                    const z = parseFloat(data.tcp.z);
                    
                    document.getElementById('tcp-x').textContent = formatNum(x);
                    document.getElementById('tcp-y').textContent = formatNum(y);
                    document.getElementById('tcp-z').textContent = formatNum(z);
                    
                    // Get track position
                    const trackPos = data.track ? parseFloat(data.track) : 0;
                    
                    // Calculate velocities
                    if (lastPosition && lastPositionTime) {
                        const dt = (now - lastPositionTime) / 1000; // seconds
                        if (dt > 0) {
                            // TCP velocity
                            const dx = x - lastPosition.x;
                            const dy = y - lastPosition.y;
                            const dz = z - lastPosition.z;
                            const tcpSpeed = Math.sqrt(dx*dx + dy*dy + dz*dz) / dt / 1000; // m/s
                            document.getElementById('tcp-speed').textContent = tcpSpeed.toFixed(3);
                            
                            // Track velocity
                            const dTrack = Math.abs(trackPos - lastPosition.track);
                            const trackSpeed = dTrack / dt / 1000; // m/s
                            document.getElementById('track-speed').textContent = trackSpeed.toFixed(3);
                        }
                    }
                    
                    // Store current position for next calculation
                    lastPosition = { x, y, z, track: trackPos };
                    lastPositionTime = now;
                }
                
                if (data.joints) {
                    document.getElementById('joint-1').textContent = formatNum(data.joints.j1);
                    document.getElementById('joint-2').textContent = formatNum(data.joints.j2);
                    document.getElementById('joint-3').textContent = formatNum(data.joints.j3);
                    document.getElementById('joint-4').textContent = formatNum(data.joints.j4);
                    document.getElementById('joint-5').textContent = formatNum(data.joints.j5);
                    document.getElementById('joint-6').textContent = formatNum(data.joints.j6);
                }
                
                if (data.track) {
                    document.getElementById('joint-track').textContent = formatNum(data.track) + ' mm';
                }
            } catch (error) {
                console.error('Position refresh failed:', error);
            }
        }

        async function refreshEvents() {
            try {
                const response = await fetch('/api/events/?num=5');
                const data = await response.json();
                
                const container = document.getElementById('event-log');
                if (data.events && data.events.length > 0) {
                    container.innerHTML = data.events.map(e => {
                        const typeClass = e.type === '1' ? 'text-red-400' : 
                                         e.type === '2' ? 'text-yellow-400' : 'text-gray-400';
                        return `<div class="${typeClass} truncate">${e.title || 'Unknown event'}</div>`;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="text-gray-500">No recent events</div>';
                }
            } catch (error) {
                console.error('Events refresh failed:', error);
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks/');
                const data = await response.json();
                
                const select = document.getElementById('task-select');
                select.innerHTML = '';
                
                if (data.tasks && data.tasks.length > 0) {
                    data.tasks.forEach(task => {
                        const option = document.createElement('option');
                        option.value = task;
                        option.textContent = task;
                        select.appendChild(option);
                    });
                    loadModules();
                } else {
                    select.innerHTML = '<option value="">No tasks found</option>';
                }
            } catch (error) {
                console.error('Failed to load tasks:', error);
            }
        }

        async function loadModules() {
            const task = document.getElementById('task-select').value;
            const select = document.getElementById('module-select');
            
            if (!task) {
                select.innerHTML = '<option value="">Select a task first</option>';
                return;
            }
            
            try {
                const response = await fetch(`/api/modules/${task}/`);
                const data = await response.json();
                
                select.innerHTML = '';
                
                if (data.modules && data.modules.length > 0) {
                    data.modules.forEach(module => {
                        const option = document.createElement('option');
                        option.value = module;
                        option.textContent = module;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No modules found</option>';
                }
            } catch (error) {
                console.error('Failed to load modules:', error);
            }
        }

        async function startExecution() {
            showMessage('Starting program...', 'info');
            try {
                const response = await fetch('/api/start/', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Program started', 'success');
                } else {
                    showMessage(data.error || 'Failed to start', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
            refreshStatus();
        }

        async function stopExecution() {
            showMessage('Stopping program...', 'info');
            try {
                const response = await fetch('/api/stop/', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Program stopped', 'success');
                } else {
                    showMessage(data.error || 'Failed to stop', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
            refreshStatus();
        }

        async function resetPP() {
            const task = document.getElementById('task-select').value || 'T_ROB1';
            showMessage('Resetting program pointer...', 'info');
            
            try {
                const response = await fetch('/api/reset-pp/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task })
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Program pointer reset', 'success');
                } else {
                    showMessage(data.error || 'Failed to reset', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function showMessage(text, type) {
            const el = document.getElementById('control-message');
            el.textContent = text;
            el.className = 'mt-4 text-sm p-3 rounded';
            
            if (type === 'success') {
                el.className += ' bg-green-900 text-green-200';
            } else if (type === 'error') {
                el.className += ' bg-red-900 text-red-200';
            } else {
                el.className += ' bg-blue-900 text-blue-200';
            }
        }

        // =====================================================================
        // System Diagnostics
        // =====================================================================
        
        let lastDiagnostics = null;

        async function refreshDiagnostics() {
            try {
                const response = await fetch('/api/diagnostics/');
                const data = await response.json();
                
                updateHealthBadge(data.health);
                updateHealthBanner(data);
                renderDiagnosticTables(data.diagnostics);
                
                // Flash the update indicator
                const indicator = document.getElementById('diag-update-indicator');
                indicator.classList.remove('animate-pulse');
                setTimeout(() => indicator.classList.add('animate-pulse'), 50);
                
                lastDiagnostics = data;
            } catch (error) {
                console.error('Diagnostics refresh failed:', error);
                updateHealthBadge('error');
            }
        }

        function updateHealthBadge(health) {
            const badge = document.getElementById('health-badge');
            const labels = {
                'ok': 'All Systems OK',
                'warning': 'Warning',
                'critical': 'Critical',
                'unknown': 'Unknown',
                'error': 'Error'
            };
            const colors = {
                'ok': 'bg-green-600 text-green-100',
                'warning': 'bg-yellow-600 text-yellow-100',
                'critical': 'bg-red-600 text-red-100',
                'unknown': 'bg-gray-600 text-gray-100',
                'error': 'bg-red-800 text-red-100'
            };
            
            badge.textContent = labels[health] || 'Unknown';
            badge.className = `px-2 py-1 text-xs font-medium rounded-full ${colors[health] || colors.unknown}`;
        }

        function updateHealthBanner(data) {
            const banner = document.getElementById('health-banner');
            const icon = document.getElementById('health-icon');
            const message = document.getElementById('health-message');
            
            if (data.health === 'ok' || data.health === 'unknown') {
                banner.classList.add('hidden');
                return;
            }
            
            banner.classList.remove('hidden');
            
            if (data.health === 'critical') {
                banner.className = 'mb-4 p-3 rounded-lg bg-red-900/50 border border-red-700';
                icon.innerHTML = '<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                message.textContent = `Critical: ${data.issues.join(', ')}`;
                message.className = 'text-sm font-medium text-red-200';
            } else if (data.health === 'warning') {
                banner.className = 'mb-4 p-3 rounded-lg bg-yellow-900/50 border border-yellow-700';
                icon.innerHTML = '<svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                message.textContent = `Warning: ${data.warnings.join(', ')}`;
                message.className = 'text-sm font-medium text-yellow-200';
            }
        }

        function renderDiagnosticTables(diagnostics) {
            const grid = document.getElementById('diagnostics-grid');
            
            if (!diagnostics || Object.keys(diagnostics).length === 0) {
                grid.innerHTML = '<div class="text-gray-500 text-center py-8 col-span-full">No diagnostic data available</div>';
                return;
            }
            
            // Category order and icons
            const categoryOrder = ['safety', 'drives', 'mode', 'status', 'safety_ctrl', 'tools'];
            const categoryIcons = {
                'safety': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>',
                'drives': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>',
                'mode': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>',
                'status': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>',
                'safety_ctrl': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>',
                'tools': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>'
            };
            
            let html = '';
            
            for (const key of categoryOrder) {
                const category = diagnostics[key];
                if (!category) continue;
                
                const hasAnyFault = category.signals.some(s => s.status === 'fault');
                const allAvailable = category.signals.every(s => s.available);
                const headerColor = hasAnyFault ? 'text-red-400' : 'text-gray-300';
                
                html += `
                    <div class="bg-gray-700/50 rounded-lg overflow-hidden">
                        <div class="px-3 py-2 bg-gray-700 flex items-center gap-2 ${headerColor}">
                            ${categoryIcons[key] || ''}
                            <span class="font-medium text-sm">${category.label}</span>
                        </div>
                        <table class="w-full text-sm">
                            <tbody>
                `;
                
                for (const signal of category.signals) {
                    // Status colors: ok=green, fault=red, on=blue, off=gray, unknown=gray
                    let statusColor, rowClass = '', pulseClass = '';
                    if (signal.status === 'ok') {
                        statusColor = 'bg-green-500';
                    } else if (signal.status === 'fault') {
                        statusColor = 'bg-red-500';
                        rowClass = 'bg-red-900/20';
                        pulseClass = 'animate-pulse';
                    } else if (signal.status === 'on') {
                        statusColor = 'bg-blue-500';
                    } else if (signal.status === 'off') {
                        statusColor = 'bg-gray-500';
                    } else {
                        statusColor = 'bg-gray-500';
                    }
                    
                    const typeColor = signal.type === 'DI' ? 'text-blue-400' : 'text-purple-400';
                    const valueDisplay = signal.available ? signal.value : '-';
                    
                    html += `
                        <tr class="border-t border-gray-600/50 ${rowClass}">
                            <td class="px-3 py-2">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full ${statusColor} ${pulseClass}"></span>
                                    <span class="text-gray-300">${signal.label}</span>
                                </div>
                            </td>
                            <td class="px-2 py-2 text-right">
                                <span class="${typeColor} text-xs font-mono">${signal.type}</span>
                            </td>
                            <td class="px-3 py-2 text-right font-mono text-gray-400 w-8">
                                ${valueDisplay}
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }

        // Tool Changer status refresh
        async function refreshToolChanger() {
            try {
                const response = await fetch('/api/tool-changer/');
                const data = await response.json();
                
                // Update tool number and name
                document.getElementById('tc-tool-num').textContent = data.tool_num || '-';
                document.getElementById('tc-tool-name').textContent = data.tool_name || 'Unknown';
                
                // Update tool state with color coding
                const stateEl = document.getElementById('tc-state');
                const stateColors = {
                    'gripped': 'text-green-400',
                    'released': 'text-blue-400',
                    'releasing': 'text-yellow-400',
                    'gripping': 'text-yellow-400',
                    'error': 'text-red-400',
                    'unknown': 'text-gray-400'
                };
                const stateLabels = {
                    'gripped': '🔒 Gripped',
                    'released': '🔓 Released',
                    'releasing': '⏳ Releasing...',
                    'gripping': '⏳ Gripping...',
                    'error': '⚠️ Error',
                    'unknown': '? Unknown'
                };
                stateEl.textContent = stateLabels[data.tool_state] || data.tool_state;
                stateEl.className = `text-xl font-semibold ${stateColors[data.tool_state] || 'text-gray-400'}`;
                
                // Update signal indicators
                const signals = data.signals || {};
                updateSignalDot('tc-do13', signals.DO13_Release?.active);
                updateSignalDot('tc-di13', signals.DI13_Released?.active);
                updateSignalDot('tc-do14', signals.DO14_Grip?.active);
                updateSignalDot('tc-di14', signals.DI14_Gripped?.active);
                updateSignalDot('tc-di2', signals.DI2_HeliHome?.active);
                
                // Fetch program pointer for debugging
                const ppResponse = await fetch('/api/status/?extended=true');
                const ppData = await ppResponse.json();
                const pp = ppData.program_pointer || {};
                const progPtrEl = document.getElementById('tc-prog-ptr');
                const progLineEl = document.getElementById('tc-prog-line');
                if (progPtrEl && pp.routine) {
                    progPtrEl.textContent = `${pp.module || ''}.${pp.routine || ''}`;
                    progLineEl.textContent = pp.range ? `Line ${pp.range}` : '';
                } else if (progPtrEl) {
                    progPtrEl.textContent = pp.module || '-';
                    progLineEl.textContent = '';
                }
                
            } catch (error) {
                console.error('Tool changer refresh error:', error);
            }
        }
        
        function updateSignalDot(elementId, active) {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (active === true) {
                el.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
            } else if (active === false) {
                el.className = 'w-2.5 h-2.5 rounded-full bg-gray-500';
            } else {
                el.className = 'w-2.5 h-2.5 rounded-full bg-gray-600';
            }
        }

        // Activity Log and Alerts
        let seenAlertIds = new Set();
        let lastActivityTimestamp = null;
        
        async function refreshActivityLog() {
            try {
                const response = await fetch('/api/activity-log/?count=50');
                const data = await response.json();
                
                renderActivityLog(data.activity || []);
                renderAlerts(data.alerts || []);
                
            } catch (error) {
                console.error('Activity log refresh error:', error);
            }
        }
        
        function formatLogTime(timestamp) {
            // timestamp format: "2026-01-21 T 10:28:28"
            if (!timestamp) return '';
            const parts = timestamp.split(' T ');
            if (parts.length === 2) {
                return parts[1]; // Just return time portion
            }
            return timestamp;
        }
        
        function renderActivityLog(activities) {
            const container = document.getElementById('activity-log');
            if (!container) return;
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No activity</div>';
                return;
            }
            
            let html = '';
            for (const event of activities.slice(0, 30)) {
                const time = formatLogTime(event.timestamp);
                const isNew = lastActivityTimestamp && event.timestamp > lastActivityTimestamp;
                const newClass = isNew ? 'bg-blue-900/30' : '';
                
                html += `
                    <div class="flex gap-2 py-1 px-2 rounded ${newClass} hover:bg-gray-700/50">
                        <span class="text-gray-500 shrink-0">${time}</span>
                        <span class="text-gray-300">${event.title || ''}</span>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Update last timestamp for highlighting new entries
            if (activities.length > 0) {
                lastActivityTimestamp = activities[0].timestamp;
            }
        }
        
        function renderAlerts(alerts) {
            const container = document.getElementById('alerts-log');
            const countBadge = document.getElementById('alert-count');
            if (!container) return;
            
            // Count new alerts
            const newAlerts = alerts.filter(a => !seenAlertIds.has(a.timestamp + a.code));
            
            // Update count badge
            if (countBadge) {
                const count = alerts.length;
                countBadge.textContent = count;
                if (newAlerts.length > 0) {
                    countBadge.className = 'px-2 py-0.5 text-xs font-medium rounded-full bg-red-600 text-white animate-pulse';
                } else if (count > 0) {
                    countBadge.className = 'px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-600 text-white';
                } else {
                    countBadge.className = 'px-2 py-0.5 text-xs font-medium rounded-full bg-gray-600 text-gray-300';
                }
            }
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No alerts</div>';
                return;
            }
            
            let html = '';
            for (const alert of alerts.slice(0, 20)) {
                const alertId = alert.timestamp + alert.code;
                const isNew = !seenAlertIds.has(alertId);
                const isError = alert.type === 'error';
                
                const bgClass = isNew ? (isError ? 'bg-red-900/40 border-red-700' : 'bg-yellow-900/40 border-yellow-700') 
                                       : 'bg-gray-700/30 border-gray-600';
                const iconClass = isError ? 'text-red-400' : 'text-yellow-400';
                const icon = isError ? '⛔' : '⚠️';
                
                html += `
                    <div class="p-2 rounded border ${bgClass}">
                        <div class="flex items-start gap-2">
                            <span class="${iconClass}">${icon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-medium text-gray-200">${alert.title || 'Alert'}</span>
                                    <span class="text-xs text-gray-500">${formatLogTime(alert.timestamp)}</span>
                                </div>
                                ${alert.description ? `<div class="text-xs text-gray-400 line-clamp-2">${alert.description}</div>` : ''}
                                ${alert.causes ? `<div class="text-xs text-gray-500 mt-1">Cause: ${alert.causes}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Mark as seen
                seenAlertIds.add(alertId);
            }
            
            container.innerHTML = html;
        }
        
        function clearAlertHighlights() {
            // Clear seen alerts to reset highlighting on next refresh
            seenAlertIds.clear();
            const countBadge = document.getElementById('alert-count');
            if (countBadge) {
                countBadge.className = 'px-2 py-0.5 text-xs font-medium rounded-full bg-gray-600 text-gray-300';
            }
        }
    </script>
</body>
</html>
